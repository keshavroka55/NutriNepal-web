{% extends "base.html" %}
{% block title %}Daily Nutrition Trends{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Daily Nutrition Summary</h1>
    <div>
      <a class="btn btn-sm btn-secondary" href="{% url 'daily_kcal_summary' %}">Refresh</a>
      <a class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" href="#tableSection" role="button" aria-expanded="false" aria-controls="tableSection">
        Toggle Table
      </a>
    </div>
  </div>

  {% if daily_kcal %}
    {# safe json for JS (Django's json_script) #}
    {{ daily_kcal|default:"[]"|json_script:"daily_kcal_json" }}

    <!-- Summary cards -->
    <div class="row g-3 mb-4">
      <div class="col-sm-6 col-md-3">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <small class="text-muted">Latest Date</small>
            <h5 id="latestDate" class="card-title mt-1">--</h5>
            <div class="text-muted small" id="latestSummary">-- kcal • -- g protein</div>
          </div>
        </div>
      </div>

      <div class="col-sm-6 col-md-3">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <small class="text-muted">Latest Total kcal</small>
            <h5 id="latestKcal" class="card-title mt-1">--</h5>
            <div class="text-muted small">Compared to 7-day avg below</div>
          </div>
        </div>
      </div>

      <div class="col-sm-6 col-md-3">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <small class="text-muted">7-day Avg kcal</small>
            <h5 id="avgKcal7" class="card-title mt-1">--</h5>
            <div class="text-muted small">Trend over last 7 days</div>
          </div>
        </div>
      </div>

      <div class="col-sm-6 col-md-3">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <small class="text-muted">View</small>
            <div class="mt-2">
              <div class="form-check form-check-inline">
                <input class="form-check-input nutrient-toggle" type="checkbox" id="toggleKcal" checked data-dataset="0">
                <label class="form-check-label" for="toggleKcal">Calories</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input nutrient-toggle" type="checkbox" id="toggleProtein" checked data-dataset="1">
                <label class="form-check-label" for="toggleProtein">Protein</label>
              </div>
              {% comment %} <div class="form-check form-check-inline">
                <input class="form-check-input nutrient-toggle" type="checkbox" id="toggleFat" checked data-dataset="2">
                <label class="form-check-label" for="toggleFat">Fat</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input nutrient-toggle" type="checkbox" id="toggleCarbs" checked data-dataset="3">
                <label class="form-check-label" for="toggleCarbs">Carbs</label>
              </div> {% endcomment %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <canvas id="nutritionChart" height="120" style="max-height:420px;"></canvas>
      </div>
    </div>

    <!-- Table (collapsible) -->
    <div class="collapse show" id="tableSection">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered mb-0">
              <thead class="thead-light">
                <tr>
                  <th>Date</th>
                  <th class="text-end">Total kcal</th>
                  <th class="text-end">Protein (g)</th>
                  <th class="text-end">Fat (g)</th>
                  <th class="text-end">Carbs (g)</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                {% for row in daily_kcal %}
                <tr>
                  <td>{{ row.date }}</td>
                  <td class="text-end">{{ row.total_kcal|default_if_none:"0.0"|floatformat:1 }}</td>
                  <td class="text-end">{{ row.total_protein|default_if_none:"0.0"|floatformat:1 }}</td>
                  <td class="text-end">{{ row.total_fat|default_if_none:"0.0"|floatformat:1 }}</td>
                  <td class="text-end">{{ row.total_carbs|default_if_none:"0.0"|floatformat:1 }}</td>
                  <td>
                    <a class="btn btn-sm btn-primary"
                       href="{% url 'daily_kcal_detail' row.date.year row.date.month row.date.day %}">
                      View
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  {% else %}
    <div class="alert alert-info">No meal entries yet.</div>
  {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const raw = JSON.parse(document.getElementById('daily_kcal_json').textContent || '[]');
  if (!raw.length) return;

  // Build arrays (assume date strings like 'YYYY-MM-DD')
  const labels = raw.map(r => r.date);
  const kcal = raw.map(r => (r.total_kcal == null ? 0 : Number(r.total_kcal)));
  const protein = raw.map(r => (r.total_protein == null ? 0 : Number(r.total_protein)));
  const fat = raw.map(r => (r.total_fat == null ? 0 : Number(r.total_fat)));
  const carbs = raw.map(r => (r.total_carbs == null ? 0 : Number(r.total_carbs)));

  // compute latest and 7-day average
  const latest = raw[raw.length - 1];
  const last7 = raw.slice(-7);
  const avg7 = (arr) => Math.round((arr.reduce((s,v)=> s + (v.total_kcal||0), 0) / (arr.length||1)) * 10) / 10;

  document.getElementById('latestDate').textContent = latest.date;
  document.getElementById('latestSummary').textContent = `${latest.total_kcal || 0} kcal • ${latest.total_protein || 0} g protein`;
  document.getElementById('latestKcal').textContent = `${latest.total_kcal || 0} kcal`;
  document.getElementById('avgKcal7').textContent = `${avg7(last7)} kcal`;

  // Chart.js datasets
  const datasets = [
    { label: 'Calories (kcal)', data: kcal, yAxisID: 'y', tension: 0.2 },
    { label: 'Protein (g)', data: protein, yAxisID: 'y1', tension: 0.2 },
    {% comment %} { label: 'Fat (g)', data: fat, yAxisID: 'y1', tension: 0.2 },
    { label: 'Carbs (g)', data: carbs, yAxisID: 'y1', tension: 0.2 }, {% endcomment %}
  ];

  // Basic color palette (kept subtle)
  const palette = ['#0d6efd','#198754','#fd7e14','#6f42c1'];
  datasets.forEach((d,i)=> {
    d.borderColor = palette[i];
    d.backgroundColor = palette[i] + '22'; // translucent fill
    d.fill = false;
    d.pointRadius = 3;
    d.pointHoverRadius = 6;
  });

  const ctx = document.getElementById('nutritionChart').getContext('2d');
  const nutritionChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      plugins: {
        legend: { display: true, position: 'top' },
        tooltip: {
          callbacks: {
            label: function(context) {
              const v = context.raw;
              return `${context.dataset.label}: ${v}`;
            }
          }
        }
      },
      scales: {
        x: {
          type: 'category',
          ticks: {
            maxRotation: 0,
            callback: function(val, index) {
              // show only every N label if many
              const total = labels.length;
              const showEvery = total > 15 ? Math.ceil(total / 10) : 1;
              return (index % showEvery === 0) ? labels[index] : '';
            }
          }
        },
        // primary axis for kcal
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          title: { display: true, text: 'Calories (kcal)' }
        },
        // secondary axis for grams (protein/fat/carbs)
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Grams (g)' }
        }
      }
    }
  });

  // Toggle handling
  document.querySelectorAll('.nutrient-toggle').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const idx = Number(e.target.dataset.dataset);
      nutritionChart.setDatasetVisibility(idx, e.target.checked);
      nutritionChart.update();
    });
  });

});
</script>
{% endblock %}
