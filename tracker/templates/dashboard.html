{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}

{% block content %}
<div class="dashboard-wrap">
  <main class="main" id="mainContent">
    
    <header class="main-header">
      <div class="title-block">
        <div>
          <h1>üìä Dashboard ‚Äî {{ date }}</h1>
          <p class="subtitle">Track your daily nutrition & reach your goals</p>
        </div>
      </div>
      <div class="header-actions">
        <a href="#" class="icon-btn">
          <i class="fa fa-bell"></i>
        </a>
        <a href="{% url 'userprofile' %}" class="icon-btn">
          <i class="fa fa-user-circle"></i>
        </a>
      </div>
    </header>

    <section class="summary-row">
      <div class="stat-card">
        <div class="stat-label">Daily Goal</div>
        <div class="stat-value">
          {{ target_kcal|default:"0" }} 
          <span class="unit">kcal</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Total Eaten</div>
        <div class="stat-value">
          {{ total_kcal|default:"0" }} 
          <span class="unit">kcal</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">Remaining</div>
        <div class="stat-value">
          {{ remaining_kcal|default:"0" }} 
          <span class="unit">kcal</span>
        </div>
      </div>
    </section>

    <div class="content-grid">
      
      <section class="chart-card">
        <h2 class="section-title">Macronutrient Breakdown</h2>
        
        <div class="chart-container">
          <canvas id="macroChart"></canvas>
        </div>

        <div class="macro-values">
          <div class="macro-item">
            <strong>üí™ Protein</strong>
            <span class="macro-number">{{ total_protein|default:"0" }} g</span>
          </div>
          <div class="macro-item">
            <strong>ü•ë Fat</strong>
            <span class="macro-number">{{ total_fat|default:"0" }} g</span>
          </div>
          <div class="macro-item">
            <strong>üåæ Carbs</strong>
            <span class="macro-number">{{ total_carbs|default:"0" }} g</span>
          </div>
        </div>
      </section>

      <section class="meals-card">
        <div class="meals-header">
          <h2 class="section-title">üçΩÔ∏è Today's Meals</h2>
        </div>

        {% if entries %}
        <div class="table-wrap">
          <table class="meals-table">
            <thead>
              <tr>
                <th>Food</th>
                <th>Calories</th>
                <th>Protein</th>
                <th>Fat</th>
                <th>Carbs</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in entries %}
              <tr>
                <td>{{ entry.food.name }}</td>
                <td>{{ entry.kcal }} kcal</td>
                <td>{{ entry.protein_g }} g</td>
                <td>{{ entry.fat_g }} g</td>
                <td>{{ entry.carbs_g }} g</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty-state">
          <p class="empty-msg">No meals added for today yet. Start tracking your nutrition!</p>
        </div>
        {% endif %}

        <div class="action-row">
          <a href="{% url 'meal_create' %}" class="btn btn-primary">
            ‚ûï Add Meal
          </a>
          <a href="{% url 'food_create' %}" class="btn btn-secondary">
            üçé Create Food
          </a>
          <a href="{% url 'foods_list' %}" class="btn btn-ghost">
            üìö Food List
          </a>
        </div>
      </section>

    </div>

  </main>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
  const ctx = document.getElementById('macroChart');
  if (!ctx) return;

  const proteinValue = Number("{{ total_protein|default:0 }}");
  const fatValue = Number("{{ total_fat|default:0 }}");
  const carbsValue = Number("{{ total_carbs|default:0 }}");
  
  const hasData = proteinValue > 0 || fatValue > 0 || carbsValue > 0;
  const displayData = hasData ? [proteinValue, fatValue, carbsValue] : [30, 20, 50];

  new Chart(ctx.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: ['Protein', 'Fat', 'Carbs'],
      datasets: [{
        data: displayData,
        backgroundColor: [
          'rgba(99, 102, 241, 0.8)',
          'rgba(236, 72, 153, 0.8)',
          'rgba(245, 158, 11, 0.8)'
        ],
        borderColor: [
          'rgba(99, 102, 241, 1)',
          'rgba(236, 72, 153, 1)',
          'rgba(245, 158, 11, 1)'
        ],
        borderWidth: 2,
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: {
              size: 13,
              family: "'Inter', sans-serif",
              weight: '600'
            },
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: { size: 14, weight: '600' },
          bodyFont: { size: 13 },
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              const suffix = hasData ? 'g' : 'g (sample)';
              return label + ': ' + value + suffix;
            }
          }
        }
      },
      cutout: '60%'
    }
  });

  if (!hasData) {
    const centerText = document.createElement('div');
    centerText.className = 'chart-center-text';
    centerText.innerHTML = '<strong>No data yet</strong><br><small>Add meals to see your macros</small>';
    ctx.parentElement.appendChild(centerText);
  }
})();
</script>

{% endblock %}